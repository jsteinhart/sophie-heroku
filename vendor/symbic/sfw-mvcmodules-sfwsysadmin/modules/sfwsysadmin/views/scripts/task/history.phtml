<?php if (empty($this->history)): ?>
<div class="notice">
	No history available.
</div>
<?php return; endif; ?>

<?php

$module = 'sfwsysadmin';
$this->headLink()->appendStylesheet($this->sfwModuleAssetUrl('module.css', $module));
$this->inlineScript()->appendFile($this->sfwModuleAssetUrl('module.js', $module));

$firstJob = reset($this->history);

?>

<h1>History of <em><?php echo $this->escape($firstJob['name']); ?></em></h1>
<?php if (!empty($firstJob['description'])): ?>
<p>
	<?php echo nl2br($this->escape($firstJob['description'])); ?>
</p>
<?php endif; ?>

<table class="sfwsysadminTaskHistory">
<tr>
	<th>ID</th>
	<th>Creation Date</th>
	<th>Start Date</th>
	<th>Finish Date</th>
	<th>Duration</th>
	<th>Retries</th>
	<th>Logs</th>
</tr>
<?php foreach ($this->history as &$job):
	$logBlockId = 'sfwsysadminTaskLog' . (int)$job['id'];
	$logEntries = array();
	foreach ($job['log'] as &$log):
		$img = '../Icons.inactive/help.png';
		$alt = 'Unknown';
		switch ($log['type']):
			case 'message':
				$img = 'comment.png';
				$img = 'email.png';
				$alt = 'Message';
				break;
			case 'notice':
				$img = 'information.png';
				$alt = 'Notice';
				break;
			case 'warning':
				$img = 'error.png';
				$alt = 'Warning';
				break;
			case 'error':
				$img = 'exclamation.png';
				$alt = 'Error';
				break;
			case 'exception':
				$img = 'exclamation.png';
				$alt = 'Exception';
				break;
		endswitch;
		if (!isset($logEntries[ $img ])):
			$logEntries[ $img ] = '<img src="/_media/Icons/' . $img . '" alt="' . $this->escape($this->T($alt)) . '" title="' . $this->escape($this->T($alt)) . '" />';
		endif;
	endforeach;
	unset($log); // to destroy the reference and allow using the $log variable later

	if (!empty($logEntries)):
		echo '<tr ondblclick="sfwsysadminToggle(\'' . $logBlockId . '\')">';
	else:
		echo '<tr>';
	endif;
	?>
		<td class="right"><?php echo $this->escape($job['id']); ?></td>
		<?php foreach (array('creationDateTS', 'startDateTS', 'finishDateTS') as $key): ?>
		<td>
			<?php
				echo (empty($job[$key]))
					? '&ndash;'
					: date('Y-m-d H:i:s', $job[ $key ]);
			?>
		</td>
		<?php endforeach; ?>
		<td class="right"><?php echo number_format($job['jobDuration'], 3); ?> s</td>
		<td class="right"><?php echo (empty($job['retryMax'])) ? '&ndash; ' : $this->escape($job['retryCount'] . '/' . $job['retryMax']); ?></td>
		<td>
			<?php
				if (!empty($logEntries)):
					echo '<a href="javascript:sfwsysadminToggle(\'' . $logBlockId . '\')">';
					echo implode(PHP_EOL, $logEntries);
					echo '</a>';
				endif;
			?>
		</td>
	</tr>
	<?php if (!empty($logEntries)): ?>
		<tr id="<?php echo $this->escape($logBlockId); ?>" ondblclick="sfwsysadminToggle('<?php echo $this->escape($logBlockId); ?>')" class="logHidden">
			<td colspan="7">
				<ul class="logs">
				<?php foreach ($job['log'] as $log): ?>
					<li class="<?php echo $this->escape($log['type']); ?>">
						<?php echo date('Y-m-d H:i:s', $log['date']) . ':'; ?>
						<div class="logContent">
							<?php echo nl2br($this->escape($log['content'])); ?>
						</div>
					</li>
				<?php endforeach; ?>
				</ul>
			</td>
		</tr>
	<?php endif; ?>
<?php endforeach; ?>
</table>

<p>
	Displaying the most recent <?php echo count($this->history); ?> of <?php echo $this->escape($this->historyLength); ?> log items.
</p>